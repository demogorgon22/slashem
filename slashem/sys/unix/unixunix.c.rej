***************
*** 149,158 ****
  	for(i = 1; i <= MAXDUNGEON*MAXLEVEL + 1; i++) {
  		/* try to remove all */
  		set_levelfile_name(lock, i);
! 		(void) unlink(lock);
  	}
  	set_levelfile_name(lock, 0);
! 	if(unlink(lock)) return(0);			/* cannot remove it */
  	return(1);					/* success! */
  }
  
--- 161,171 ----
  	for(i = 1; i <= MAXDUNGEON*MAXLEVEL + 1; i++) {
  		/* try to remove all */
  		set_levelfile_name(lock, i);
! 		(void) unlink(fqname(lock, LEVELPREFIX, 0));
  	}
  	set_levelfile_name(lock, 0);
! 	if (unlink(fqname(lock, LEVELPREFIX, 0)))
! 		return(0);				/* cannot remove it */
  	return(1);					/* success! */
  }
  
***************
*** 193,199 ****
  #endif
  
  	/* we ignore QUIT and INT at this point */
! 	if (!lock_file(HLOCK, 10)) {
  		wait_synch();
  		error("%s", "");
  	}
--- 207,213 ----
  #endif
  
  	/* we ignore QUIT and INT at this point */
! 	if (!lock_file(HLOCK, LOCKPREFIX, 10)) {
  		wait_synch();
  		error("%s", "");
  	}
***************
*** 206,217 ****
  
  		do {
  			lock[0] = 'a' + i++;
  
! 			if((fd = open(lock, 0)) == -1) {
  			    if(errno == ENOENT) goto gotlock; /* no such file */
! 			    perror(lock);
  			    unlock_file(HLOCK);
! 			    error("Cannot open %s", lock);
  			}
  
  			if(veryold(fd) /* closes fd if true */
--- 220,232 ----
  
  		do {
  			lock[0] = 'a' + i++;
+ 			fq_lock = fqname(lock, LEVELPREFIX, 0);
  
! 			if((fd = open(fq_lock, 0)) == -1) {
  			    if(errno == ENOENT) goto gotlock; /* no such file */
! 			    perror(fq_lock);
  			    unlock_file(HLOCK);
! 			    error("Cannot open %s", fq_lock);
  			}
  
  			if(veryold(fd) /* closes fd if true */
***************
*** 223,233 ****
  		unlock_file(HLOCK);
  		error("Too many hacks running now.");
  	} else {
! 		if((fd = open(lock, 0)) == -1) {
  			if(errno == ENOENT) goto gotlock;    /* no such file */
! 			perror(lock);
  			unlock_file(HLOCK);
! 			error("Cannot open %s", lock);
  		}
  
  		if(veryold(fd) /* closes fd if true */ && eraseoldlocks())
--- 238,249 ----
  		unlock_file(HLOCK);
  		error("Too many hacks running now.");
  	} else {
! 		fq_lock = fqname(lock, LEVELPREFIX, 0);
! 		if((fd = open(fq_lock, 0)) == -1) {
  			if(errno == ENOENT) goto gotlock;    /* no such file */
! 			perror(fq_lock);
  			unlock_file(HLOCK);
! 			error("Cannot open %s", fq_lock);
  		}
  
  		if(veryold(fd) /* closes fd if true */ && eraseoldlocks())
***************
*** 259,275 ****
  	}
  
  gotlock:
! 	fd = creat(lock, FCMASK);
  	unlock_file(HLOCK);
  	if(fd == -1) {
! 		error("cannot creat lock file.");
  	} else {
  		if(write(fd, (genericptr_t) &hackpid, sizeof(hackpid))
  		    != sizeof(hackpid)){
! 			error("cannot write lock");
  		}
  		if(close(fd) == -1) {
! 			error("cannot close lock");
  		}
  	}
  }
--- 275,291 ----
  	}
  
  gotlock:
! 	fd = creat(fq_lock, FCMASK);
  	unlock_file(HLOCK);
  	if(fd == -1) {
! 		error("cannot creat lock file (%s).", fq_lock);
  	} else {
  		if(write(fd, (genericptr_t) &hackpid, sizeof(hackpid))
  		    != sizeof(hackpid)){
! 			error("cannot write lock (%s)", fq_lock);
  		}
  		if(close(fd) == -1) {
! 			error("cannot close lock (%s)", fq_lock);
  		}
  	}
  }
