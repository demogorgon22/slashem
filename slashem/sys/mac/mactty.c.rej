***************
*** 59,68 ****
   */
  static short
  mem_err (void) {
! 	if (MemError ()) {
! 		return MemError ();
  	}
! 	return general_failure;
  }
  
  
--- 58,68 ----
   */
  static short
  mem_err (void) {
! 	short ret_val = MemError();
! 	if (!ret_val) {
! 		ret_val = general_failure;
  	}
! 	return ret_val;
  }
  
  
***************
*** 109,115 ****
  static short
  alloc_ptr (void **ptr, long size) {
  	*ptr = NewPtr (size);
! 	return *ptr ? noErr : mem_err ();
  }
  
  
--- 109,115 ----
  static short
  alloc_ptr (void **ptr, long size) {
  	*ptr = NewPtr (size);
! 	return MemError ();
  }
  
  
***************
*** 155,161 ****
  		select_offscreen_port (record);
  		SetOrigin (0, 0);
  		select_onscreen_window (record);
! 		dprintf ("New GWorld @ %lx;dm %lx CGrafPtr", gw, gw);
  	}
  	return s_err;
  }
--- 155,161 ----
  		select_offscreen_port (record);
  		SetOrigin (0, 0);
  		select_onscreen_window (record);
! 		dprintf ("New GWorld @ %lx;dm", gw);
  	}
  	return s_err;
  }
***************
*** 282,301 ****
   */
  short
  destroy_tty (WindowPtr window) {
- Boolean close_flag;
  short s_err;
  RECORD_EXISTS (record);
  
  	s_err = free_bits (record);
  	if (!s_err) {
! 		close_flag = record->was_allocated;
! 		DisposePtr ((Ptr) record);
! 		s_err = MemError ();
! 		if (close_flag) {
  			CloseWindow (window);
  		} else {
  			DisposeWindow (window);
  		}
  	}
  	
  	return s_err;
--- 282,298 ----
   */
  short
  destroy_tty (WindowPtr window) {
  short s_err;
  RECORD_EXISTS (record);
  
  	s_err = free_bits (record);
  	if (!s_err) {
! 		if (record->was_allocated) {
  			CloseWindow (window);
  		} else {
  			DisposeWindow (window);
  		}
+ 		s_err = dispose_ptr (record);
  	}
  	
  	return s_err;
***************
*** 307,313 ****
  
  	PenNormal ();
  	TextFont (record->font_number);
- 	TextFace (0);
  	TextSize (record->font_size);
  	if (0L != (record->attribute [TTY_ATTRIB_FLAGS] & TA_OVERSTRIKE)) {
  		TextMode (srcOr);
--- 304,309 ----
  
  	PenNormal ();
  	TextFont (record->font_number);
  	TextSize (record->font_size);
  	if (0L != (record->attribute [TTY_ATTRIB_FLAGS] & TA_OVERSTRIKE)) {
  		TextMode (srcOr);
***************
*** 456,468 ****
  	}
  	else	source = &record->its_bits;
  	
- 	GetForeColor (&old_fore);
- 	GetBackColor (&old_back);
- 	RGBForeColor (&rgb_black);
- 	RGBBackColor (&rgb_white);
  	CopyBits (source, &(record->its_window->portBits), bounds, bounds, xfer_mode, mask_rgn);
- 	RGBForeColor (&old_fore);
- 	RGBBackColor (&old_back);
  
  	if (record->uses_gworld) {
  		SetPixelsState (GetGWorldPixMap (record->offscreen_world), pix_state);
--- 449,455 ----
  	}
  	else	source = &record->its_bits;
  	
  	CopyBits (source, &(record->its_window->portBits), bounds, bounds, xfer_mode, mask_rgn);
  
  	if (record->uses_gworld) {
  		SetPixelsState (GetGWorldPixMap (record->offscreen_world), pix_state);
***************
*** 475,493 ****
   */
  static void
  erase_rect (tty_record *record, Rect *area) {
! 	if (u.uhp > 0 && iflags.use_stone && record->its_window == _mt_window) {
  		PixPatHandle ppat;
  		
  		ppat = GetPixPat(iflags.use_stone + 127);	/* find which pat to get */
! 		if (!ppat) {
! 			EraseRect (area);
! 		} else {
  			FillCRect (area, ppat);
  			DisposePixPat (ppat);
  		}
  	}
! 	else
! 		EraseRect (area);
  }
  
  
--- 462,478 ----
   */
  static void
  erase_rect (tty_record *record, Rect *area) {
! 	if (game_active && u.uhp > 0 && iflags.use_stone && record->its_window == _mt_window) {
  		PixPatHandle ppat;
  		
  		ppat = GetPixPat(iflags.use_stone + 127);	/* find which pat to get */
! 		if (ppat) {	/* in game window, using backgroung pattern, and have pattern */
  			FillCRect (area, ppat);
  			DisposePixPat (ppat);
+ 			return;
  		}
  	}
! 	EraseRect (area);
  }
  
  
***************
*** 500,511 ****
  short s_err;
  RECORD_EXISTS (record);
  
! 	if (s_err = free_bits (record)) {
  		return s_err;
  	}
  	calc_font_sizes (record);
  
! 	if (s_err = alloc_bits (record)) {
  /*
   * Catastrophe! We could not allocate memory for the bitmap! Things may go very
   * much downhill from here!
--- 485,498 ----
  short s_err;
  RECORD_EXISTS (record);
  
! 	s_err = free_bits (record);
! 	if (s_err) {
  		return s_err;
  	}
  	calc_font_sizes (record);
  
! 	s_err = alloc_bits (record);
! 	if (s_err) {
  /*
   * Catastrophe! We could not allocate memory for the bitmap! Things may go very
   * much downhill from here!
***************
*** 515,521 ****
  	}
  	select_offscreen_port (record);
  	do_set_port_font (record);
- 	select_onscreen_window (record);
  	return clear_tty (window);
  }
  
--- 502,507 ----
  	}
  	select_offscreen_port (record);
  	do_set_port_font (record);
  	return clear_tty (window);
  }
  
***************
*** 633,639 ****
  move_tty_cursor (WindowPtr window, short x_pos, short y_pos) {
  RECORD_EXISTS (record);
  
- 	select_onscreen_window (record);
  	if (record->x_curs == x_pos && record->y_curs == y_pos) {
  		return noErr;
  	}
--- 648,653 ----
  move_tty_cursor (WindowPtr window, short x_pos, short y_pos) {
  RECORD_EXISTS (record);
  
  	if (record->x_curs == x_pos && record->y_curs == y_pos) {
  		return noErr;
  	}
***************
*** 694,700 ****
  static void
  do_add_string (tty_record *record, char *str, short len) {
  Rect r;
- register int x_pos, count = len;
  
  	if (len < 1) {
  		return;
--- 708,713 ----
  static void
  do_add_string (tty_record *record, char *str, short len) {
  Rect r;
  
  	if (len < 1) {
  		return;
***************
*** 767,777 ****
  		case CHAR_LF :
  			record->y_curs++;
  			if (record->y_curs >= record->y_size) {
! 				scroll_tty (record->its_window, 0, 1 + record->y_curs -
! 					record->y_size);
  			}
  			if (!recurse && (record->attribute [TTY_ATTRIB_CURSOR] & TA_NL_ADD_CR)) {
! 				character = 13;
  				recurse = 1;
  			}
  			else recurse = 0;
--- 780,789 ----
  		case CHAR_LF :
  			record->y_curs++;
  			if (record->y_curs >= record->y_size) {
! 				scroll_tty (record->its_window, 0, 1 + record->y_curs - record->y_size);
  			}
  			if (!recurse && (record->attribute [TTY_ATTRIB_CURSOR] & TA_NL_ADD_CR)) {
! 				character = CHAR_CR;
  				recurse = 1;
  			}
  			else recurse = 0;
***************
*** 827,832 ****
  register short max_x, pos_x;
  RECORD_EXISTS (record);
  
  	the_c = (const unsigned char *) string;
  	max_x = record->x_size;
  	tty_wrap = (record->attribute [TTY_ATTRIB_FLAGS] & TA_WRAP_AROUND);
--- 842,850 ----
  register short max_x, pos_x;
  RECORD_EXISTS (record);
  
+ 	if (record->curs_state != 0)
+ 		curs_pos (record, record->x_curs, record->y_curs, 0);
+ 
  	the_c = (const unsigned char *) string;
  	max_x = record->x_size;
  	tty_wrap = (record->attribute [TTY_ATTRIB_FLAGS] & TA_WRAP_AROUND);
***************
*** 854,860 ****
  			the_c ++;
  		}
  	}
- 	select_onscreen_window (record);
  
  	return noErr;
  }
--- 872,877 ----
  			the_c ++;
  		}
  	}
  
  	return noErr;
  }
***************
*** 871,877 ****
  	if (attrib < 0 || attrib >= TTY_NUMBER_ATTRIBUTES) {
  		return general_failure;
  	}
! 	* value = record->attribute [attrib];
  
  	return noErr;
  }
--- 888,894 ----
  	if (attrib < 0 || attrib >= TTY_NUMBER_ATTRIBUTES) {
  		return general_failure;
  	}
! 	*value = record->attribute [attrib];
  
  	return noErr;
  }
***************
*** 915,921 ****
  		select_offscreen_port (record);
  		RGBForeColor (&rgb_color);
  		select_onscreen_window (record);
- 		RGBForeColor (&rgb_color);
  		break;
  	case TTY_ATTRIB_BACKGROUND :
  /*
--- 932,937 ----
  		select_offscreen_port (record);
  		RGBForeColor (&rgb_color);
  		select_onscreen_window (record);
  		break;
  	case TTY_ATTRIB_BACKGROUND :
  /*
***************
*** 925,931 ****
  		select_offscreen_port (record);
  		RGBBackColor (&rgb_color);
  		select_onscreen_window (record);
- 		RGBBackColor (&rgb_color);
  		break;
  	default :
  		break;
--- 941,946 ----
  		select_offscreen_port (record);
  		RGBBackColor (&rgb_color);
  		select_onscreen_window (record);
  		break;
  	default :
  		break;
***************
*** 944,950 ****
  short s_err;
  RECORD_EXISTS (record);
  
- 	select_onscreen_window (record);
  	s_err = update_tty (window);
  
  	rgn = NewRgn ();
--- 959,964 ----
  short s_err;
  RECORD_EXISTS (record);
  
  	s_err = update_tty (window);
  
  	rgn = NewRgn ();
***************
*** 974,988 ****
  short clear_tty (WindowPtr window) {
  RECORD_EXISTS (record);
  
  	select_offscreen_port (record);
  	erase_rect (record, &(record->its_bits.bounds));
! 	select_onscreen_window (record);
! 	erase_rect (record, &(record->its_bits.bounds));
! #if CLIP_RECT_ONLY
! 	empty_rect (&(record->invalid_rect));
! #else
! 	SetEmptyRgn (record->invalid_part);
! #endif
  
  	return noErr;
  }
--- 988,998 ----
  short clear_tty (WindowPtr window) {
  RECORD_EXISTS (record);
  
+ 	record->curs_state = 0;
  	select_offscreen_port (record);
  	erase_rect (record, &(record->its_bits.bounds));
! 	accumulate_rect (record, &(record->its_bits.bounds));
! 	update_tty (window);
  
  	return noErr;
  }
